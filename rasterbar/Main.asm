; (c) J.Viskari 2018
; 10 SYS (49152)

*=$0801

          BYTE $0E,$08,$0A,$00,$9E,$20,$28,$34,$39,$31,$35,$32,$29,$00,$00,$00

*=$C000

start
          JSR  init      
          SEI
          ASL  $D019     
          LDA  #$32                 ;set raster interrupt
          STA  $D012     
          CLI

infinite_loop
          LDA  #200      
@poll2
          CMP  $D012     
          BNE  @poll2    
          JSR  update_lut          ;update lookup table at line 200

          JMP  infinite_loop

init
          SEI
          LDA  #$01      
          STA  $D01A     
          STA  $DC0D     
          LDA  #$1B      
          STA  $D011     
          STA  $D012     
          LDA  #<irq_handler
          STA  $0314     
          LDA  #>irq_handler
          STA  $0315     
          CLI
          RTS

irq_handler
          SEI

          LDX  #$00      

@loop2
          LDA  work_mem_start,X
          LDY  lut_start,X

@loop1
          DEY
          BNE  @loop1    
          STA  $D020     
          STA  $D021     
          INX
          CPX  #$41      
          BNE  @loop2    

@exit
          ASL  $D019     
          JMP  $EA7E     

;===============================================================================
update_lut
          LDX  #$00      
          LDY  #$FF                    ;value gets modified do not move!
@loop
          LDA  $C300,Y   
          STA  $C100,X   

          LDA  $C302,Y   
          STA  $C108,X   

          LDA  $C304,Y   
          STA  $C110,X   

          LDA  $C306,Y   
          STA  $C118,X   

          LDA  $C308,Y   
          STA  $C120,X   

          LDA  $C30A,Y   
          STA  $C128,X   

          LDA  $C30C,Y   
          STA  $C130,X   

          LDA  $C30E,Y   
          STA  $C138,X   

          INY
          INX
          CPX  #$8       
          BNE  @loop     
          DEC  @loop-1                    ;self modifying code

          RTS
;===============================================================================

*=$C100
work_mem_start
*=$C1FF
work_mem_end

;todo create this at runtime
*=$C200
lut_start
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
          BYTE $08,$01,$08,$08,$08,$08,$08,$08
lut_end

; color map
*=$C300
lut2
          BYTE $09,$04,$0A,$0F,$07,$01,$01,$01,$01,$01,$01,$07,$0F,$0A,$04,$09,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
          BYTE $09,$08,$0A,$0F,$07,$01,$01,$01,$01,$01,$01,$07,$0F,$0A,$08,$09,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
          BYTE $06,$04,$0E,$03,$0D,$01,$01,$01,$01,$01,$01,$0D,$03,$0E,$04,$06,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
          BYTE $0B,$0C,$0F,$01,$01,$0F,$0C,$0B,$00,$00,$00,$00,$00,$00,$00,$00,$08,$0A,$0F,$07,$01,$07,$0F,$0A,$08,$00,$00,$00,$00,$00,$00,$00
          BYTE $00,$00,$00,$00,$00,$00,$00,$00,$09,$05,$0F,$07,$01,$01,$07,$0F,$05,$09,$00,$00,$00,$00,$00,$00,$09,$0B,$08,$0C,$0F,$07,$01,$01
          BYTE $01,$01,$07,$0F,$0C,$08,$0B,$09,$00,$00,$00,$00,$00,$00,$00,$00,$09,$02,$0A,$0F,$07,$01,$07,$0F,$0A,$02,$09,$00,$00,$00,$00,$00
          BYTE $06,$0E,$03,$01,$01,$03,$0E,$06,$00,$00,$00,$00,$00,$00,$00,$00,$09,$02,$08,$0A,$0F,$07,$01,$01,$01,$01,$07,$0F,$0A,$08,$02,$09
          BYTE $00,$00,$00,$00,$00,$00,$00,$00,$0B,$0C,$0F,$0D,$01,$0D,$0F,$0C,$0B,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
          BYTE $09,$04,$0A,$0F,$07,$01,$01,$01,$01,$01,$01,$07,$0F,$0A,$04,$09,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
          BYTE $09,$08,$0A,$0F,$07,$01,$01,$01,$01,$01,$01,$07,$0F,$0A,$08,$09,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
          BYTE $06,$04,$0E,$03,$0D,$01,$01,$01,$01,$01,$01,$0D,$03,$0E,$04,$06,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
          BYTE $0B,$0C,$0F,$01,$01,$0F,$0C,$0B,$00,$00,$00,$00,$00,$00,$00,$00,$08,$0A,$0F,$07,$01,$07,$0F,$0A,$08,$00,$00,$00,$00,$00,$00,$00
          BYTE $00,$00,$00,$00,$00,$00,$00,$00,$09,$05,$0F,$07,$01,$01,$07,$0F,$05,$09,$00,$00,$00,$00,$00,$00,$09,$0B,$08,$0C,$0F,$07,$01,$01
          BYTE $01,$01,$07,$0F,$0C,$08,$0B,$09,$00,$00,$00,$00,$00,$00,$00,$00,$09,$02,$0A,$0F,$07,$01,$07,$0F,$0A,$02,$09,$00,$00,$00,$00,$00
          BYTE $06,$0E,$03,$01,$01,$03,$0E,$06,$00,$00,$00,$00,$00,$00,$00,$00,$09,$02,$08,$0A,$0F,$07,$01,$01,$01,$01,$07,$0F,$0A,$08,$02,$09
          BYTE $00,$00,$00,$00,$00,$00,$00,$00,$0B,$0C,$0F,$0D,$01,$0D,$0F,$0C,$0B,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00,$00
lut2_end